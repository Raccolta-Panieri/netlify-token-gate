<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gate - Turnstile</title>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <style>
    body{font-family:system-ui,Helvetica,Arial;padding:32px;background:#f6f8fb}
    .card{max-width:700px;margin:0 auto;background:white;padding:24px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    button{background:#0b74ff;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    #status{margin:10px 0;color:#333}
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="headline">
    <h1 id="headline">Completa il CAPTCHA per essere reindirizzato</h1>

    <!-- token passato via querystring ma NON mostrato a schermo -->
    <input id="token" type="hidden" />

    <!-- widget Turnstile -->
    <div id="cf-w" class="cf-turnstile"
         data-sitekey="0x4AAAAAAB28IhGlNsVNQtcZ"
         data-callback="onTurnstileSuccess"
         data-theme="light"></div>

    <p>
      <button id="go" aria-live="polite">Verifica e vai</button>
    </p>

    <div id="status" aria-live="polite"></div>
  </div>

  <script>
    // leggi query string (non mostrata)
    (function(){ const p=new URLSearchParams(location.search); const t=p.get('t'); if(t) document.getElementById('token').value = t; })();

    let turnstileToken = "";
    const status = document.getElementById('status');
    const goBtn = document.getElementById('go');

    // callback chiamata dal widget Turnstile quando completato con successo
    window.onTurnstileSuccess = function(token) {
      turnstileToken = token || "";
      status.textContent = "Verifica CAPTCHA completata. Premi 'Verifica e vai' per continuare.";
    };

    goBtn.addEventListener('click', async () => {
      const t = document.getElementById('token').value.trim();
      if(!t){ status.textContent = "Token mancante: genera prima un token."; return; }
      if(!turnstileToken){ status.textContent = "Completa prima il CAPTCHA (clicca sul widget)."; return; }

      // disabilitiamo il bottone per evitare doppie richieste
      goBtn.disabled = true;
      status.textContent = "Contatto il server per verificare...";

      try {
        const res = await fetch('/.netlify/functions/verify-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ t: t, 'cf-turnstile-response': turnstileToken })
        });

        const j = await res.json();

        if (res.ok && j.ok && j.url) {
          status.textContent = "Reindirizzamento in corsoâ€¦";
          // redirect silenzioso
          window.location.href = j.url;
          return;
        }

        // gestione degli errori (mostriamo solo messaggio user-friendly)
        if (j && j.error) {
          status.textContent = "Verifica fallita: " + j.error;
        } else if (j && j.verify) {
          status.textContent = "Verifica CAPTCHA fallita. Riprova.";
        } else {
          status.textContent = "Errore imprevisto. Riprova.";
        }

      } catch (err) {
        status.textContent = "Errore di rete. Riprova.";
      } finally {
        // riattiviamo e resettiamo lo stato del widget per un eventuale retry.
        goBtn.disabled = false;
        // se Turnstile supporta reset: prova a resettare (se disponibile)
        if (window.turnstile && typeof window.turnstile.reset === 'function') {
          try { window.turnstile.reset(document.getElementById('cf-w')); turnstileToken = ""; } catch(e){ /* ignore */ }
        }
      }
    });
  </script>
</body>
</html>
