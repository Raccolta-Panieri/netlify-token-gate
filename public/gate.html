<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gate - Turnstile</title>

  <!-- Turnstile client -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <style>
    body{font-family:system-ui,Helvetica,Arial;padding:32px;background:#f6f8fb}
    .card{max-width:700px;margin:0 auto;background:white;padding:24px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    button{background:#0b74ff;color:white;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    input{width:100%;padding:8px;margin:8px 0}
    pre{white-space:pre-wrap;background:#f3f4f6;padding:10px;border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Gate protetto (Turnstile)</h2>
    <p>Completa il CAPTCHA per essere reindirizzato.</p>

    <label>Token (query param ?t=...)</label>
    <input id="token" placeholder="Inserisci token o lascia vuoto per leggere ?t dal querystring" />

    <!-- WIDGET: usa data-callback per ricevere il token Turnstile -->
    <div id="cf-w" class="cf-turnstile"
         data-sitekey="0x4AAAAAAB28IhGlNsVNQtcZ"
         data-callback="onTurnstileSuccess"></div>

    <p><button id="go">Verifica e vai</button></p>
    <pre id="out"></pre>
  </div>

  <script>
    // leggi querystring
    function qs(name){ const p=new URLSearchParams(location.search); return p.get(name); }
    // imposta campo token dall'url se presente
    document.getElementById('token').value = qs('t') || '';

    // variabile che conterrà il token Turnstile dopo che l'utente completa il captcha
    let turnstileToken = "";

    // callback chiamata automaticamente da Turnstile quando l'utente completa il challenge
    // (data-callback="onTurnstileSuccess" nella div)
    window.onTurnstileSuccess = function(token) {
      turnstileToken = token || "";
      document.getElementById('out').textContent = "Turnstile completato (token pronto).";
    };

    document.getElementById('go').addEventListener('click', async ()=>{
      const t = document.getElementById('token').value.trim();
      if(!t){ alert('Inserisci token'); return; }
      if(!turnstileToken){
        document.getElementById('out').textContent = "Completa prima il Turnstile (clicca sul widget).";
        return;
      }

      document.getElementById('out').textContent = "Verifico...";
      try {
        const res = await fetch('/.netlify/functions/verify-token', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            t: t,
            'cf-turnstile-response': turnstileToken
          })
        });
        const j = await res.json();
        document.getElementById('out').textContent = JSON.stringify(j, null, 2);
        if(j.ok && j.url){
          // redirect finale
          location.href = j.url;
        } else {
          // puliamo il token turnstile per forzare un nuovo challenge se serve
          turnstileToken = "";
          // se Turnstile è reloadable, l'utente potrà rifarlo manualmente
        }
      } catch(err){
        document.getElementById('out').textContent = "Errore: "+String(err);
      }
    });
  </script>
</body>
</html>
